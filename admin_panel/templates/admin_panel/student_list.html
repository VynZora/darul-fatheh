{% extends "admin_panel/base.html" %}
{% load static %}

{% block title %}Student Registrations | Darul Fatheh Admin{% endblock %}

{% block content %}
<div class="dashboard__form__wraper">
    
    <div class="create__course__title mb-4 d-flex flex-wrap justify-content-between align-items-center gap-2">
        <h4 class="mb-0">Student Registrations</h4>
        
        <div class="d-flex align-items-center gap-2 ms-auto">
            <div class="search-box">
                <input type="text" id="studentSearchInput" class="form-control form-control-sm" placeholder="Search name or phone...">
            </div>
        </div>
        
        <button class="btn btn-primary btn-sm" onclick="window.print()">
            <i class="fas fa-print"></i> Print List
        </button>
    </div>

    <div class="custom-table-container">
        <table class="table table-striped table-hover align-middle" id="studentTable">
            <thead class="table-light">
                <tr>
                    <th>Reg. Date</th>
                    <th>Full Name</th>
                    <th>Course / Program</th>
                    <th>Contact Info</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr class="searchable-student-row">
                    <td>
                        <div class="fw-bold">{{ student.registered_at|date:"M d, Y" }}</div>
                        <small class="text-muted">{{ student.registered_at|date:"h:i A" }}</small>
                    </td>
                    <td>
                        <span class="fw-bold text-dark">{{ student.first_name }} {{ student.last_name }}</span>
                    </td>
                    <td>
                        {% if student.course %}
                            <span class="badge bg-primary mb-1">{{ student.course.title }}</span><br>
                        {% else %}
                            <span class="badge bg-secondary mb-1">General</span><br>
                        {% endif %}
                        <small class="text-muted">{{ student.program_name|default:"-" }}</small>
                    </td>
                    <td>
                        <i class="fas fa-phone fa-fw text-muted small"></i> {{ student.mobile }}<br>
                        <i class="fas fa-envelope fa-fw text-muted small"></i> {{ student.email }}
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-info text-white me-1" data-bs-toggle="modal" data-bs-target="#viewModal{{ student.id }}" title="View Full Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        
                        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ student.id }}" title="Delete Record">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>

                <div class="modal fade" id="viewModal{{ student.id }}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-light">
                                <h5 class="modal-title">Student Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold">First Name</label>
                                        <div class="form-control-plaintext border-bottom">{{ student.first_name }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold">Last Name</label>
                                        <div class="form-control-plaintext border-bottom">{{ student.last_name }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold">Date of Birth</label>
                                        <div class="form-control-plaintext border-bottom">{{ student.dob|date:"F d, Y" }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold">Registered On</label>
                                        <div class="form-control-plaintext border-bottom">{{ student.registered_at }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold">Email</label>
                                        <div class="form-control-plaintext border-bottom"><a href="mailto:{{ student.email }}">{{ student.email }}</a></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold">Phone</label>
                                        <div class="form-control-plaintext border-bottom"><a href="tel:{{ student.mobile }}">{{ student.mobile }}</a></div>
                                    </div>
                                    <div class="col-md-12 mt-4">
                                        <h6 class="border-bottom pb-2 mb-3">Course Information</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold">Course Level</label>
                                        <div class="form-control-plaintext">{{ student.course.title|default:"Not Selected" }}</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="small text-muted fw-bold">Specific Program</label>
                                        <div class="form-control-plaintext">{{ student.program_name|default:"Not Provided" }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="deleteModal{{ student.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form method="post" action="{% url 'admin_panel:student_delete' student.pk %}">
                                {% csrf_token %}
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title">Delete Registration</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>Are you sure you want to delete the registration for <strong>{{ student.first_name }} {{ student.last_name }}</strong>?</p>
                                    <p class="text-danger small mb-0"><i class="fas fa-exclamation-triangle"></i> This action cannot be undone.</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-danger">Confirm Delete</button>
                                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                {% empty %}
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <i class="fas fa-user-graduate fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No students have registered yet.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% include 'admin_panel/pagination.html' with items=students %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Inherited Styles from Events List */
    .thumb-image { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; }
    .search-box { width: 250px; position: relative; }
    .search-box input { border-radius: 20px; padding-left: 15px; padding-right: 32px; font-size: 14px; border: 1px solid #ced4da; }
    .search-box::after { content: "\f002"; font-family: "Font Awesome 5 Free"; font-weight: 900; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; pointer-events: none; font-size: 13px; }
    .custom-table-container { width: 100%; overflow-x: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; background: white; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .custom-table-container table { min-width: 900px; width: 100%; margin-bottom: 0; }
    
    /* View Modal Specifics */
    .form-control-plaintext { padding-top: 0; padding-bottom: 5px; color: #212529; }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CUSTOMIZE HIGHLIGHT COLOR HERE
    const highlightColor = '#fff9c4'; // Change this to your preferred color

    const searchInput = document.getElementById('studentSearchInput');
    const rows = document.querySelectorAll('.searchable-student-row');
    const searchableColumns = [1, 2, 3, 4]; // Reg Date, Full Name, Course/Program, Contact Info

    // Store original text for searchable cells
    rows.forEach(row => {
        searchableColumns.forEach(index => {
            const cell = row.querySelector(`td:nth-child(${index})`);
            if (cell) {
                cell.dataset.originalText = cell.innerHTML; // Use innerHTML to preserve structure
            }
        });
    });

    function escapeRegex(text) {
        return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlight(html, keyword) {
        if (!keyword) return html;
        
        // Create a temporary div to work with HTML
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        // Get all text nodes
        const textNodes = [];
        const walker = document.createTreeWalker(temp, NodeFilter.SHOW_TEXT, null, false);
        let node;
        while (node = walker.nextNode()) {
            textNodes.push(node);
        }
        
        // Highlight text in text nodes
        const regex = new RegExp(`(${escapeRegex(keyword)})`, 'gi');
        textNodes.forEach(textNode => {
            const text = textNode.textContent;
            if (regex.test(text)) {
                const span = document.createElement('span');
                span.innerHTML = text.replace(regex, `<mark style="background-color: ${highlightColor}; padding: 2px 4px; border-radius: 3px;">$1</mark>`);
                textNode.parentNode.replaceChild(span, textNode);
            }
        });
        
        return temp.innerHTML;
    }

    searchInput.addEventListener('input', function() {
        const keyword = this.value.trim().toLowerCase();

        rows.forEach(row => {
            let matched = false;

            searchableColumns.forEach(index => {
                const cell = row.querySelector(`td:nth-child(${index})`);
                if (!cell) return;

                const original = cell.dataset.originalText;
                const lower = cell.textContent.toLowerCase();

                if (keyword && lower.includes(keyword)) {
                    matched = true;
                    cell.innerHTML = highlight(original, keyword);
                } else {
                    cell.innerHTML = original;
                }
            });

            row.style.display = matched || keyword === '' ? '' : 'none';
        });
    });
});
</script>
{% endblock %}