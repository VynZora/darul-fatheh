{% extends "admin_panel/base.html" %}
{% load static %}

{% block title %}News List | Darul Fatheh Admin{% endblock %}

{% block extra_css %}
<style>
    /* Standardized Table & Search Box */
    .custom-table-container { overflow-x: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; background: white; }
    .search-box { width: 250px; position: relative; }
    .search-box::after { content: "\f002"; font-family: "Font Awesome 5 Free"; font-weight: 900; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; pointer-events: none; }
    
    /* CKEditor Height Matching */
    .ck-editor__editable {
        min-height: 250px !important;
        max-height: 500px !important;
    }
    
    .modal-header { background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; }
    .form-label { font-weight: 600; color: #444; }
    .news-thumb { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard__form__wraper">
    <div class="create__course__title mb-4 d-flex flex-wrap justify-content-between align-items-center gap-2">
        <h4 class="mb-0">News Management</h4>
        <div class="d-flex align-items-center gap-2 ms-auto">
            <div class="search-box">
                <input type="text" id="newsSearchInput" class="form-control form-control-sm" placeholder="Search news...">
            </div>
        </div>
        <a href="{% url 'admin_panel:news_create' %}" class="btn btn-success btn-sm">
            <i class="fas fa-plus"></i> Add News
        </a>
    </div>

    <div class="custom-table-container">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th scope="col">Image</th>
                    <th scope="col">Title</th>
                    <th scope="col">Published Date</th>
                    <th scope="col" class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="news-table-body">
                {% for item in news %}
                <tr class="searchable-news-row">
                    <td>
                        {% if item.image %}
                            <img src="{{ item.image.url }}" alt="" class="news-thumb">
                        {% else %}
                            <div class="bg-light d-flex align-items-center justify-content-center news-thumb">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                        {% endif %}
                    </td>
                    <td><strong>{{ item.title }}</strong></td>
                    <td>{{ item.published_date|date:"M d, Y" }}</td>
                    <td class="text-center">
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-warning me-1" data-bs-toggle="modal" data-bs-target="#updateNewsModal{{ item.id }}">
                                Update
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteNewsModal{{ item.id }}">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="mt-3">
        {% include 'admin_panel/pagination.html' with items=news %}
    </div>
</div>

{% for item in news %}
<div class="modal fade" id="updateNewsModal{{ item.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" enctype="multipart/form-data" action="{% url 'admin_panel:news_edit' item.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Edit News: {{ item.title|truncatechars:30 }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">News Title</label>
                        <input type="text" name="title" class="form-control" value="{{ item.title }}" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Content</label>
                        <textarea name="content" class="form-control news-modal-editor" id="newsEditor{{ item.id }}">{{ item.content }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Featured Image</label>
                        <input type="file" name="image" class="form-control news-img-input" data-preview="#newsPrev{{ item.id }}" accept="image/*">
                        {% if item.image %}
                        <div class="mt-2 text-center">
                            <img id="newsPrev{{ item.id }}" src="{{ item.image.url }}" class="img-fluid rounded shadow-sm" style="max-height: 150px;">
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Save Changes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
<script>
    const newsEditors = new Map();

    document.addEventListener('DOMContentLoaded', function () {
        // Standardized CKEditor Loader
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('show.bs.modal', function () {
                const textarea = this.querySelector('textarea.news-modal-editor');
                if (textarea && !newsEditors.has(textarea.id)) {
                    ClassicEditor
                        .create(textarea, {
                            toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', 'undo', 'redo']
                        })
                        .then(editor => {
                            newsEditors.set(textarea.id, editor);
                        })
                        .catch(error => console.error(error));
                }
            });
        });

        // News Search Logic
        const searchInput = document.getElementById('newsSearchInput');
        searchInput.addEventListener('input', function () {
            const keyword = this.value.toLowerCase();
            document.querySelectorAll('.searchable-news-row').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(keyword) ? '' : 'none';
            });
        });

        // Image Preview Logic
        document.querySelectorAll('.news-img-input').forEach(input => {
            input.addEventListener('change', function () {
                const preview = document.querySelector(this.dataset.preview);
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => preview.src = e.target.result;
                    reader.readAsDataURL(this.files[0]);
                }
            });
        });
    });
</script>
{% endblock %}